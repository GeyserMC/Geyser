name: Compilar Geyser 3.0 (Time Heist)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configurar Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Instalar LibFakeTime
        run: |
          sudo apt-get update
          sudo apt-get install -y libfaketime

      - name: Forzar Puerto 25565
        run: |
          archivo="bootstrap/bungeecord/src/main/java/org/geysermc/geyser/platform/bungeecord/GeyserBungeePlugin.java"
          sed -i 's/return findCompatibleListener().*mapToInt.*;/return 25565;/g' $archivo
          
          echo "--- Verificación del código ---"
          grep -C 5 "getServerPort" $archivo

      - name: Dar permisos
        run: chmod +x gradlew

      # --- FASE 1: ROBAR DEPENDENCIAS DEL PASADO (Architectury) ---
      # Viajamos al 7 de Enero para descargar las librerías que caducan el 8.
      # Ignoramos los errores porque Fabric fallará aquí.
      - name: "Fase 1: Time Heist (7 Enero)"
        continue-on-error: true
        run: |
          # Configurar viaje en el tiempo
          LIBFAKETIME_PATH=$(find /usr/lib -name "libfaketime.so.1" | head -n 1)
          export LD_PRELOAD="$LIBFAKETIME_PATH"
          export DONT_FAKE_MONOTONIC=1
          export FAKETIME="@2026-01-07 12:00:00"
          
          echo ">>> FECHA DEL PASADO: $(date)"
          echo ">>> Intentando descargar plugins antiguos..."
          
          # Ejecutamos una compilación parcial. Fallará, pero descargará lo que necesitamos.
          ./gradlew :build-logic:tasks --no-daemon || true

      # --- FASE 2: COMPILAR EN EL PRESENTE (Fabric) ---
      # Volvemos a la fecha real. Architectury ya estará en caché. Fabric descargará bien ahora.
      - name: "Fase 2: Compilación Final (Presente)"
        run: |
          # Desactivar viaje en el tiempo (volvemos a la fecha real del servidor)
          unset LD_PRELOAD
          unset FAKETIME
          
          echo ">>> FECHA ACTUAL: $(date)"
          echo ">>> Reanudando compilación con caché mixta..."
          
          # Compilamos de verdad
          ./gradlew :bungeecord:build -x test --no-daemon --stacktrace

      - name: Subir el archivo compilado
        uses: actions/upload-artifact@v4
        with:
          name: Geyser-Bungee-Puerto-25565
          path: bootstrap/bungeecord/build/libs/*jar
